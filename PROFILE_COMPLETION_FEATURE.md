# ميزة إكمال الملف الشخصي بعد التسجيل

## نظرة عامة
تم تطوير نظام متكامل لإجبار المستخدمين الجدد على إكمال بياناتهم الشخصية الأساسية بعد التسجيل مباشرة، مع دعم كامل لنظام الإحالة (Referral System) وطلبات الصداقة.

---

## الملفات المُنشأة

### 1. Migration - إضافة حقل الاسم الشخصي
**المسار:** `database/migrations/2025_10_02_000000_add_personal_name_to_profiles_table.php`

```php
// يضيف حقل personal_name إلى جدول profiles
Schema::table('profiles', function (Blueprint $table) {
    $table->string('personal_name')->nullable()->after('user_id');
});
```

**الحالة:** ✅ تم تشغيله بنجاح

---

### 2. Livewire Component - CompleteProfile
**المسار:** `app/Http/Livewire/Profile/CompleteProfile.php`

#### الوظائف الرئيسية:

##### أ) `mount()`
- يتحقق من وجود `personal_name` في الملف الشخصي
- إذا لم يكن موجوداً، يعرض النافذة المنبثقة
- يكتشف تلقائياً إذا كان المستخدم مُحالاً من مستخدم آخر
- يرسل إشعاراً للمُحيل عند أول تحميل للصفحة
- يملأ البريد الإلكتروني تلقائياً إذا كان موجوداً

##### ب) `saveAndFinish()`
- يحفظ الاسم الشخصي والبريد الإلكتروني
- يرسل طلب صداقة للمُحيل (إذا تم اختياره)
- يعيد التوجيه إلى لوحة التحكم

##### ج) `continueToProfile()`
- يحفظ البيانات الأساسية
- يرسل طلب صداقة للمُحيل (إذا تم اختياره)
- يعيد التوجيه إلى صفحة تعديل الملف الشخصي الكامل

##### د) `sendFriendRequest()`
- يتحقق من عدم وجود طلب صداقة سابق
- ينشئ طلب صداقة بحالة `pending`
- يرسل إشعاراً للمُحيل

##### هـ) `sendReferralNotification()`
- يتحقق من عدم وجود إشعار سابق (لتجنب التكرار)
- ينشئ إشعاراً من نوع `referral_registered`
- يتضمن معلومات المستخدم الجديد (الاسم، الصورة، المعرف)

#### خصائص الـ Component:
```php
public $showModal = false;           // التحكم في عرض النافذة
public $name = '';                   // الاسم الشخصي
public $email = '';                  // البريد الإلكتروني
public $send_friend_request = false; // إرسال طلب صداقة
public $referrer_id = null;          // معرف المُحيل
public $referrer_name = '';          // اسم المُحيل
public $notification_sent = false;   // منع تكرار الإشعارات
```

#### قواعد التحقق:
```php
'name' => 'required|string|min:3|max:100'
'email' => 'required|email|unique:users,email,{user_id}'
```

---

### 3. Blade View - واجهة النافذة المنبثقة
**المسار:** `resources/views/livewire/profile/complete-profile.blade.php`

#### المميزات:
- ✅ تصميم عصري بألوان متدرجة (Gradient)
- ✅ نافذة غير قابلة للإغلاق (Modal Backdrop)
- ✅ دعم كامل للغة العربية (RTL)
- ✅ رسائل خطأ واضحة للحقول
- ✅ حالات تحميل (Loading States) للأزرار
- ✅ عرض معلومات المُحيل إذا وُجد
- ✅ مربع اختيار لإرسال طلب صداقة
- ✅ زران للإجراءات:
  - **حفظ وإنهاء** → العودة للوحة التحكم
  - **متابعة وإكمال الملف الشخصي** → الانتقال لصفحة التعديل الكاملة

#### الألوان المستخدمة:
- **Header Gradient:** `#667eea` → `#764ba2`
- **زر الحفظ:** `#667eea` → `#764ba2`
- **زر المتابعة:** `#4299e1` → `#3182ce`
- **تنبيه المُحيل:** `#48bb78` → `#38a169`

---

## الملفات المُعدّلة

### 1. Profile Model
**المسار:** `app/Models/Profile.php`

**التعديل:**
```php
protected $fillable = [
    'user_id',
    'personal_name',  // ← تمت الإضافة
    'cover_photo',
    'date_of_birth',
];
```

---

### 2. Dashboard View
**المسار:** `resources/views/livewire/dashboard/dashboard.blade.php`

**التعديل:**
```blade
<div>
    <!-- Complete Profile Modal -->
    @livewire('profile.complete-profile')  <!-- ← تمت الإضافة -->
    
    <!-- باقي محتوى اللوحة -->
</div>
```

---

### 3. Routes
**المسار:** `routes/web.php`

**التعديل:**
```php
// Edit Profile page
Route::get('/profile-edit', \App\Http\Livewire\Profile\Edit::class)
    ->name('profile.edit');  // ← تمت الإضافة
```

---

## سير العمل (Workflow)

### 1. تسجيل مستخدم جديد
```
المستخدم يملأ نموذج التسجيل
    ↓
يتم إنشاء الحساب بنجاح
    ↓
تسجيل دخول تلقائي
    ↓
إعادة توجيه إلى لوحة التحكم
    ↓
يتم تحميل CompleteProfile Component
    ↓
يتحقق من وجود personal_name
    ↓
إذا لم يكن موجوداً → عرض النافذة المنبثقة
```

### 2. عرض النافذة المنبثقة
```
النافذة تظهر تلقائياً
    ↓
يتم التحقق من وجود مُحيل (referred_by)
    ↓
إذا وُجد مُحيل:
    - عرض اسم المُحيل
    - إرسال إشعار للمُحيل (مرة واحدة فقط)
    - عرض مربع اختيار لطلب الصداقة
    ↓
المستخدم يملأ:
    - الاسم الشخصي (إجباري)
    - البريد الإلكتروني (إجباري)
    - طلب صداقة للمُحيل (اختياري)
```

### 3. حفظ البيانات
```
المستخدم يضغط على أحد الزرين:

أ) حفظ وإنهاء:
    ↓
    حفظ personal_name في جدول profiles
    ↓
    حفظ email في جدول users (إذا لم يكن موجوداً)
    ↓
    إرسال طلب صداقة (إذا تم اختياره)
    ↓
    إخفاء النافذة
    ↓
    البقاء في لوحة التحكم

ب) متابعة وإكمال الملف:
    ↓
    حفظ personal_name في جدول profiles
    ↓
    حفظ email في جدول users (إذا لم يكن موجوداً)
    ↓
    إرسال طلب صداقة (إذا تم اختياره)
    ↓
    إخفاء النافذة
    ↓
    التوجه إلى صفحة تعديل الملف الشخصي
```

---

## نظام الإشعارات

### 1. إشعار التسجيل بالإحالة
**النوع:** `referral_registered`

**يُرسل إلى:** المستخدم المُحيل (Referrer)

**المحتوى:**
```php
[
    'user_id' => $referrer->id,
    'from_user_id' => $new_user->id,
    'type' => 'referral_registered',
    'title' => 'تسجيل مستخدم جديد',
    'message' => 'قام {اسم المستخدم} بالتسجيل باستخدام الاسم المرجعي الخاص بك',
    'data' => [
        'new_user_id' => $new_user->id,
        'new_user_name' => $new_user->getDisplayName(),
        'new_user_avatar' => $new_user->getAvatarUrl(),
    ],
]
```

**التوقيت:** يُرسل فوراً عند تحميل النافذة المنبثقة (في `mount()`)

**الحماية من التكرار:** يتحقق من عدم وجود إشعار سابق بنفس النوع من نفس المستخدم

---

### 2. إشعار طلب الصداقة
**النوع:** `friend_request`

**يُرسل إلى:** المستخدم المُحيل (إذا تم اختيار إرسال طلب صداقة)

**المحتوى:** يتم إنشاؤه عبر `Notification::createFriendRequest()`

**التوقيت:** يُرسل عند الضغط على أحد زري الحفظ (إذا تم تفعيل الخيار)

**الحماية من التكرار:** يتحقق من عدم وجود علاقة صداقة سابقة

---

## نظام طلبات الصداقة

### إنشاء طلب الصداقة
```php
Friendship::create([
    'user_id' => $new_user->id,
    'friend_id' => $referrer->id,
    'status' => 'pending',
]);
```

### التحقق من عدم التكرار
```php
$existingFriendship = Friendship::where(function ($query) use ($user, $referrer) {
    $query->where('user_id', $user->id)
          ->where('friend_id', $referrer->id);
})->orWhere(function ($query) use ($user, $referrer) {
    $query->where('user_id', $referrer->id)
          ->where('friend_id', $user->id);
})->first();
```

---

## الأمان والتحقق

### 1. التحقق من البيانات
- ✅ الاسم الشخصي: إجباري، 3-100 حرف
- ✅ البريد الإلكتروني: إجباري، صيغة صحيحة، فريد (مع استثناء المستخدم الحالي)

### 2. منع التكرار
- ✅ الإشعارات: يتحقق من عدم وجود إشعار سابق
- ✅ طلبات الصداقة: يتحقق من عدم وجود علاقة سابقة
- ✅ إرسال الإشعار: يُرسل مرة واحدة فقط عند التحميل الأول

### 3. النافذة غير قابلة للإغلاق
- ✅ لا يوجد زر إغلاق (X)
- ✅ الـ backdrop غير قابل للنقر
- ✅ يجب إكمال البيانات للمتابعة

---

## الاختبار

### سيناريو 1: تسجيل بدون إحالة
```
1. التسجيل بدون معامل ?ref= في الرابط
2. الدخول إلى لوحة التحكم
3. يجب أن تظهر النافذة المنبثقة
4. يجب أن تحتوي على:
   - حقل الاسم الشخصي (فارغ)
   - حقل البريد الإلكتروني (مملوء إذا سجل بالبريد)
   - لا يوجد قسم المُحيل
5. ملء البيانات والضغط على "حفظ وإنهاء"
6. يجب البقاء في لوحة التحكم
7. يجب عدم ظهور النافذة مرة أخرى
```

### سيناريو 2: تسجيل بإحالة
```
1. التسجيل باستخدام ?ref=username في الرابط
2. الدخول إلى لوحة التحكم
3. يجب أن تظهر النافذة المنبثقة
4. يجب أن تحتوي على:
   - حقل الاسم الشخصي (فارغ)
   - حقل البريد الإلكتروني (مملوء إذا سجل بالبريد)
   - قسم المُحيل مع اسمه
   - مربع اختيار لطلب الصداقة
5. يجب أن يستلم المُحيل إشعاراً فوراً
6. تفعيل مربع طلب الصداقة
7. ملء البيانات والضغط على "متابعة وإكمال الملف"
8. يجب التوجه إلى صفحة تعديل الملف الشخصي
9. يجب أن يستلم المُحيل إشعار طلب صداقة
```

### سيناريو 3: التحقق من البيانات
```
1. فتح النافذة المنبثقة
2. محاولة الحفظ بدون ملء البيانات
3. يجب ظهور رسائل خطأ
4. ملء اسم قصير (أقل من 3 أحرف)
5. يجب ظهور رسالة خطأ
6. ملء بريد إلكتروني غير صحيح
7. يجب ظهور رسالة خطأ
8. ملء بريد إلكتروني مستخدم بالفعل
9. يجب ظهور رسالة خطأ
```

---

## الملاحظات المهمة

### 1. شرط ظهور النافذة
النافذة تظهر فقط إذا:
```php
!$user->profile || !$user->profile->personal_name
```

### 2. إعادة ظهور النافذة
لإعادة ظهور النافذة لمستخدم معين (للاختبار):
```sql
UPDATE profiles SET personal_name = NULL WHERE user_id = {user_id};
```

### 3. البريد الإلكتروني
- إذا سجل المستخدم برقم هاتف، يمكنه إضافة بريده في النافذة
- إذا سجل بالبريد، يتم ملؤه تلقائياً ويمكن تعديله

### 4. الإشعارات
- إشعار التسجيل يُرسل مرة واحدة عند أول تحميل
- إشعار طلب الصداقة يُرسل فقط إذا تم اختياره
- كلا الإشعارين محميان من التكرار

---

## التطويرات المستقبلية المقترحة

### 1. إضافة حقول إضافية
- تاريخ الميلاد
- الجنس
- الموقع (البلد، المدينة)

### 2. خطوات متعددة
- تقسيم النموذج إلى خطوات (Wizard)
- شريط تقدم (Progress Bar)

### 3. التحقق المتقدم
- التحقق من البريد الإلكتروني عبر OTP
- التحقق من رقم الهاتف

### 4. مكافآت الإحالة
- منح نقاط للمُحيل عند إكمال المستخدم الجديد لملفه
- نظام مستويات للإحالات

---

## الدعم الفني

### المشاكل الشائعة

#### 1. النافذة لا تظهر
**الحل:**
- تأكد من تشغيل الـ migration
- تأكد من أن `personal_name` فارغ في قاعدة البيانات
- تأكد من إضافة `@livewire('profile.complete-profile')` في dashboard

#### 2. الإشعارات لا تُرسل
**الحل:**
- تأكد من وجود جدول `notifications`
- تأكد من أن `Notification::create()` يعمل بشكل صحيح
- تحقق من الـ logs في `storage/logs/laravel.log`

#### 3. طلب الصداقة لا يُنشأ
**الحل:**
- تأكد من وجود جدول `friendships`
- تأكد من أن `Notification::createFriendRequest()` موجود
- تحقق من الـ logs

---

## الخلاصة

تم تطوير نظام متكامل لإكمال الملف الشخصي بعد التسجيل مع:
- ✅ نافذة منبثقة إجبارية
- ✅ دعم كامل لنظام الإحالة
- ✅ إشعارات تلقائية للمُحيل
- ✅ نظام طلبات صداقة اختياري
- ✅ تصميم عصري وجذاب
- ✅ دعم كامل للغة العربية
- ✅ حماية من التكرار
- ✅ التحقق الكامل من البيانات

**تاريخ الإنشاء:** 2025-10-02
**الحالة:** ✅ جاهز للاستخدام